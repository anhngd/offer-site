var zmDraggable={drag_div:null,image:null,clicked:false,start_x:0,start_y:0,baseY:0,mouseBaseY:0,disbaleMove:false,getMousePosition:function(c){if(c.pageX||c.pageY){return{left:c.pageX,top:c.pageY}}else{var a=document.documentElement||document.body;return{left:(c.clientX+a.scrollLeft-a.clientLeft),top:(c.clientY+a.scrollTop-a.clientTop)}}},onMouseUp:function(){zmDraggable.clicked=false},onMouseDown:function(b){if(zmDraggable.disbaleMove){return false}zmDraggable.clicked=true;var a=zm(this).position();zmDraggable.baseY=a.top;zmDraggable.mouseBaseY=zmDraggable.getMousePosition(b).top;return false},onMouseMove:function(c){if(zmDraggable.clicked){var b=(zmDraggable.image.position().top);var a=zmDraggable.getMousePosition(c);var d=b+a.top-zmDraggable.mouseBaseY;if(d>=0){zmDraggable.image.css("top","0px");return}if(d<=(zmDraggable.drag_div.height()-zmDraggable.image.height())){zmDraggable.image.css("top",(zmDraggable.drag_div.height()-zmDraggable.image.height())+"px");return}zmDraggable.image.css("top",d+"px");zmDraggable.mouseBaseY=a.top}},startDrag:function(b,c){function a(d){return false}zmDraggable.image=zm("#"+c);zmDraggable.image.css({position:"absolute"});zmDraggable.image.bind("dragstart",a).bind("dragenter",a);zmDraggable.drag_div=zm("#"+b);zmDraggable.drag_div.mousedown(zmDraggable.onMouseDown).mousemove(zmDraggable.onMouseMove).bind("selectstart",a);zm(document).mouseup(zmDraggable.onMouseUp)}};var zmCoverV4={boxytpl:null,tab:null,themeTpl:null,zmCoverBoxy:null,isChanged:false,tid:0,isUpload:false,image_origin:"",image_position:0,image_url:"",init:function(){if(zm("#idcover").size()==0){top.location.href=zmConfig.PROFILE_URL+"/"+zmConfig.viewerName+"#showtpl";return}zmCoverV4.isChanged=false;zmCoverV4.showBoxyCover();zmCoverV4.handleMenuTab()},showBoxyCover:function(){if(zmConfig.viewerId>0){if(!zmCoverV4.zmCoverBoxy){zmCoverV4.zmCoverBoxy=new zm.Boxy({title:"Cài đặt ảnh bìa cho riêng bạn",content:zmCoverV4.getBoxyTpl(),okButton:"Đồng ý",cancelButton:"Hủy bỏ",boxyClass:"pu_larger pu_zmtheme",okClass:"submitbtn zmbtn01 disable",onClose:function(){zmCoverV4.isUpload=false;zmCoverV4.isChanged=false},onOk:function(){if(zmCoverV4.isUpload===false){zmCoverV4.saveSelectedCover()}else{zmCoverV4.saveUploadCover()}}})}else{zmCoverV4.isUpload=false;zm("#theme_menutab a").removeClass("selected").find("span").remove();zm("#theme_menutab a[rel='zme']").addClass("selected").append("<span></span>");zm(".zmpubtn .submitbtn").addClass("zmbtn01").addClass("disable")}zmCoverV4.getListCateCover()}else{zm.Boxy.alert("Bạn phải đăng nhập trước","Thông báo",3000);return}},getListCateCover:function(){zm.post("/cover/tpl/listcatecover?sid="+zmConfig.signkey,{},{dataType:"html"},function(a){zm("#ctncover").html(a);zm("#tpl_lists").click(function(b){b.preventDefault()});zmCoverV4.getListCover()})},getListCover:function(b){var a=zm("#tpl_cate"),c=a.val(),b=(typeof b=="number"?b:1);zm.post("/cover/tpl/listcover?sid="+zmConfig.signkey,{cid:c,p:b},{dataType:"json"},function(d){if(d.err===0){zm("#tpl_lists").html(d.data);zm("#tpl_pager").html(d.pager);zmCoverV4.zmCoverBoxy.show();if(zmCoverV4.isChanged===false){zm("#tpl_cate").bind("change",function(){zmCoverV4.isChanged=true;zmCoverV4.getListCover()})}}})},getBoxyTpl:function(){var a="";a+='<div class="pf_themecont">';a+='<ul class="pf_themetabs clearfix" id="theme_menutab">';a+='<li><a href="#" rel="zme" class="selected">Từ Zing Me<span></span></a></li>';a+='<li><a href="#" rel="computer">Từ Máy tính</a></li>';a+="</ul>";a+='<div class="contwrapper" id="ctncover" style="height:395px;">';a+=" </div>";a+="</div>";return a},previewCover:function(f){if(f>0){zm("#tpl_lists li").removeClass("selected");zm("#tpl_lists li span.selectedcheck.zmico").remove();zm("#zme4_cover_"+f).addClass("selected");zm("#zme4_cover_"+f).prepend('<span class="selectedcheck zmico"></span>');zmCoverV4.tid=f;var d=zm("#zme4_cover_"+f);var c=d.attr("h"),e=d.attr("p"),b=d.attr("cc");var a=c+"/"+e;zm("#themepreview").css("background-image","url("+a+")");zm(".zmpubtn .submitbtn").removeClass("zmbtn01").removeClass("disable")}},handleMenuTab:function(){zm("#theme_menutab a").click(function(b){b.preventDefault();if(zm(this).hasClass("selected")){return}else{zm(".zmpubtn .submitbtn").addClass("zmbtn01").addClass("disable");zm("#theme_menutab a").removeClass("selected").find("span").remove();zm(this).addClass("selected").append("<span></span>");var a=zm(this).attr("rel");if(a==="zme"){zmCoverV4.loadListTpl()}else{if(a==="computer"){zmCoverV4.loadUploadTpl()}else{if(a==="pkool"){zmXCall.openFullFrame({url:"http://funnyphoto.apps.zing.vn/editor/funnyphoto/full-screen-me2?from=zm&src=feed&type=computer&cover=1",width:980,height:620});zmCoverV4.zmCoverBoxy.close()}}}}})},saveSelectedCover:function(){if(typeof zmCoverV4.tid==="undefined"||zmCoverV4.tid==0){zm.Boxy.alert("Vui lòng chọn ảnh bìa để cài đặt.","Thông báo",2000);return false}zm.post("/cover/tpl/savetpl?sid="+zmConfig.signkey,{tplid:zmCoverV4.tid},{dataType:"json"},function(a){if(!a.err){zmCoverV4.zmCoverBoxy.hide();zm.Boxy.alert(a.msg,"Thông báo",2000,{beforeHide:function(){setTimeout(function(){top.location.reload()},1000)}})}else{zm.Boxy.alert(a.msg,"Thông báo",2000)}});return false},saveUploadCover:function(){if(zm("#coverfile").val()!==""){if(zmCoverV4.checkFileExtension(zm("#coverfile").val())){zmXCall.register("coverUploaded2",zmCoverV4.saveUploadCoverCallback);zm("#uploadcover").submit()}else{zm.Boxy.alert("Chỉ hỗ trợ hình ảnh dạng png , jpeg, jpg, gif","Thông báo",2000);return false}}else{zm.Boxy.alert("Bạn chưa chọn ảnh để làm ảnh bìa.","Thông báo",2000);return false}},saveUploadCoverCallback:function(a){if(a.error_code!=0){zm.Boxy.alert(a.error_message,"Thông báo",2000);return}else{zmCoverV4.image_url=a.data.theme_url;zmCoverV4.reloadImage=0;if(!zmCoverV4.imgageObj){zmCoverV4.imgageObj=new Image();zmCoverV4.imgageObj.onload=function(){zmCoverV4.editCover(zmCoverV4.image_url+"?sign="+Math.random());zmCoverV4.reloadImage=0};zmCoverV4.imgageObj.onerror=function(){if(zmCoverV4.reloadImage>10){return}zmCoverV4.reloadImage++;setTimeout(function(){zmCoverV4.imgageObj.src=zmCoverV4.image_url+"?sign="+Math.random()},500)}}zmCoverV4.imgageObj.src=a.data.theme_url+"?sign="+Math.random()}},editCover:function(b){zmCoverV4._enableEditCover();zmCoverV4.image_origin=zm("#idphotocover").attr("src");zmCoverV4.image_position=zm("#idphotocover").position().top;zm("#idphotocover").attr("src",b);zmDraggable.disbaleMove=false;if(!zmCoverV4.bindDrag){zmDraggable.startDrag("idcover","idphotocover");zmCoverV4.bindDrag=true}zmDraggable.drag_div.css("cursor","move")},_enableEditCover:function(){zm("#iddragmove").css("z-index","10");zm("#iddragmove").show();zm("#savecover_btn").show().click(function(a){a.preventDefault();zmCoverV4._disableEditCover();return zmCoverV4._saveCover()});zm("#cancelcover_btn").show().click(function(a){a.preventDefault();zm("#idphotocover").attr("src",zmCoverV4.image_origin);zm("#idphotocover").css("top",zmCoverV4.image_position+"px");return zmCoverV4._disableEditCover()});zm("#idcoverholder").show();zm("#idsetcover").hide()},_disableEditCover:function(){zm("#iddragmove").hide();zm("#savecover_btn").hide();zm("#cancelcover_btn").hide();zm("#idcoverholder").hide();zm("#idsetcover").show();zmDraggable.clicked=false;zmDraggable.disbaleMove=true;zmDraggable.drag_div.css("cursor","auto");return false},_saveCover:function(){var c=zm("#idphotocover").position().top;c=c*(-1);var d=zmCoverV4.image_url;if(d!=""){zm.getJSON("http://upload-photo.apps.zing.vn/api/saveCover/"+zmConfig.viewerName,{top:c,disk_url:d},function(a){if(a!=-1){if(zmCoverV4.pid!=undefined){(new Image()).src="/sinhnhatzingme/ajx/counter?fid="+zmCoverV4.pid+"&sign="+zmConfig.signkey+"&time="+zmConfig.time}zm.Boxy.alert("Cập nhật trang bìa thành  công","Cài đặt ảnh bìa",3000,{beforeHide:function(){top.location.reload()}})}else{zm.Boxy.alert("Chỉnh sửa không thành công, vui lòng thử lại!","Cài đặt ảnh bìa",1000);zm("#idphotocover").attr("src",zmCoverV4.image_origin);zm("#idphotocover").css("top",zmCoverV4.image_position+"px");zmCoverV4._disableEditCover()}})}else{zm.Boxy.alert("Dữ liệu không hợp lệ!","Cài đặt ảnh bìa",2000);zm("#idphotocover").attr("src",zmCoverV4.image_origin);zm("#idphotocover").css("top",zmCoverV4.image_position+"px");zmCoverV4._disableEditCover()}return false},checkFileExtension:function(a){return a.search(/\.(jpg|jpeg|gif|png)/i)!=1},loadUploadTpl:function(){zm("#coverfile").val("");zm("#covername").val("");zm.post("/cover/tpl/coverformtpl?sid="+zmConfig.signkey,{dataType:"html"},function(a){zmCoverV4.isUpload=true;zm("#ctncover").html(a);zm("#coverfile").change(function(){zm(".zmpubtn .submitbtn").removeClass("zmbtn01").removeClass("disable");zm("#covername").val(this.value)})});return false},loadListTpl:function(){zmCoverV4.isUpload=false;zmCoverV4.isChanged=false;zmCoverV4.getListCateCover()}};zm.ready(function(){zm(".zm_pfcover .ctneditcover").click(function(d){d.preventDefault();zmCoverV4.init()});try{var b=top.location.hash.substring(1);if(b==="showtpl"){var c=zm.cookie("snzm_cover");if(c){zm.cookie("snzm_cover","",{domain:"zing.vn",expires:-1});c=c.split("|");if(c.length==3){zmCoverV4.pid=c[2];zmCoverV4.image_url=c[0];zmCoverV4.editCover(c[0])}}else{zmCoverV4.init()}zmXCall.setHashParent("showtpl|"+(new Date()).getTime())}}catch(a){}});
